name: Deploy WordPress to EC2 (free tier)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  BLOG_DOMAIN: blog.aseskahraba.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          required=(EC2_HOST EC2_USER EC2_SSH_KEY RDS_ENDPOINT RDS_DB RDS_USER RDS_PASS WP_HOME WP_SITEURL LETSENCRYPT_EMAIL)
          for key in "${required[@]}"; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key" >&2
              exit 1
            fi
          done
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
          RDS_DB: ${{ secrets.RDS_DB }}
          RDS_USER: ${{ secrets.RDS_USER }}
          RDS_PASS: ${{ secrets.RDS_PASS }}
          WP_HOME: ${{ secrets.WP_HOME }}
          WP_SITEURL: ${{ secrets.WP_SITEURL }}
          LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Trust host key
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Write SSH key file
        run: |
          mkdir -p ~/.ssh
          printf "%s" "$EC2_SSH_KEY" > ~/.ssh/id_ec2
          chmod 600 ~/.ssh/id_ec2
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

      - name: Show SSH key fingerprint
        run: ssh-keygen -lf ~/.ssh/id_ec2 || (echo "Invalid private key format" && exit 1)

      - name: Debug SSH setup
        run: |
          echo "SSH agent socket: $SSH_AUTH_SOCK"
          ssh-add -l || (echo "No SSH identities loaded" && exit 1)
          echo "Testing SSH connectivityâ€¦"
          ssh -vvv -i ~/.ssh/id_ec2 -o BatchMode=yes -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo Connected to $(hostname)" || (echo "SSH test failed" && exit 1)

      - name: Prepare remote directory
        run: |
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo mkdir -p /opt/wordpress && sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} /opt/wordpress"

      - name: Install Docker on EC2
        run: |
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo dnf install -y docker docker-compose-plugin && sudo systemctl enable --now docker"

      - name: Sync project to EC2
        run: rsync -az --delete -e "ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes" ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/wordpress

      - name: Write .env on EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          cd /opt/wordpress
          cat > .env <<EOT
          WORDPRESS_DB_HOST=${RDS_ENDPOINT}
          WORDPRESS_DB_NAME=${RDS_DB}
          WORDPRESS_DB_USER=${RDS_USER}
          WORDPRESS_DB_PASSWORD=${RDS_PASS}
          WORDPRESS_TABLE_PREFIX=wp_
          WORDPRESS_DEBUG=false
          WORDPRESS_CONFIG_EXTRA="define('WP_HOME','${WP_HOME}'); define('WP_SITEURL','${WP_SITEURL}');"
          EOT
          EOF
        env:
          RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
          RDS_DB: ${{ secrets.RDS_DB }}
          RDS_USER: ${{ secrets.RDS_USER }}
          RDS_PASS: ${{ secrets.RDS_PASS }}
          WP_HOME: ${{ secrets.WP_HOME }}
          WP_SITEURL: ${{ secrets.WP_SITEURL }}

      - name: Deploy stack
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          cd /opt/wordpress
          sudo docker compose pull
          sudo docker compose up -d --remove-orphans
          sudo docker system prune -f
          EOF

      - name: Issue/Renew Let's Encrypt
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          cd /opt/wordpress
          mkdir -p certbot/conf certbot/www
          if [ -f certbot/conf/live/${BLOG_DOMAIN}/fullchain.pem ]; then
            echo "Renewing certificate for ${BLOG_DOMAIN}"
            sudo docker compose run --rm certbot renew
          else
            echo "Issuing certificate for ${BLOG_DOMAIN}"
            sudo docker compose run --rm certbot certonly \
              --webroot -w /var/www/certbot \
              -d ${BLOG_DOMAIN} \
              --email ${LETSENCRYPT_EMAIL} \
              --agree-tos --no-eff-email --non-interactive
          fi
          sudo docker compose restart nginx
          EOF
        env:
          LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}

      - name: Health check
        run: ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "curl -f http://localhost:80 || exit 1"
