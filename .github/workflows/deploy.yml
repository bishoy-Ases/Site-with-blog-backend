name: Deploy WordPress to EC2 (free tier)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  BLOG_DOMAIN: blog.aseskahraba.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          required=(EC2_HOST EC2_USER EC2_SSH_KEY RDS_ENDPOINT RDS_DB RDS_USER RDS_PASS WP_HOME WP_SITEURL LETSENCRYPT_EMAIL)
          missing=()
          for key in "${required[@]}"; do
            if [ -z "${!key}" ]; then
              missing+=("$key")
            fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "ERROR: Missing required secrets:"
            printf '  - %s\n' "${missing[@]}"
            exit 1
          fi
          echo "✓ All required secrets are present"
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
          RDS_DB: ${{ secrets.RDS_DB }}
          RDS_USER: ${{ secrets.RDS_USER }}
          RDS_PASS: ${{ secrets.RDS_PASS }}
          WP_HOME: ${{ secrets.WP_HOME }}
          WP_SITEURL: ${{ secrets.WP_SITEURL }}
          LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Sync theme files
        run: |
          echo "Ensuring theme files are synced from wp/wp-content/themes/aseskahraba/ to wordpress-theme/ases-kahraba/"
          mkdir -p wordpress-theme/ases-kahraba
          cp -r wp/wp-content/themes/aseskahraba/* wordpress-theme/ases-kahraba/ 2>/dev/null || true
          echo "Theme files synced"

      - name: Trust host key
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Write SSH key file
        run: |
          mkdir -p ~/.ssh
          printf "%s" "$EC2_SSH_KEY" > ~/.ssh/id_ec2
          chmod 600 ~/.ssh/id_ec2
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

      - name: Show SSH key fingerprint
        run: ssh-keygen -lf ~/.ssh/id_ec2 || (echo "Invalid private key format" && exit 1)

      - name: Debug SSH setup
        run: |
          echo "SSH agent socket: $SSH_AUTH_SOCK"
          ssh-add -l || (echo "No SSH identities loaded" && exit 1)
          echo "Testing SSH connectivity…"
          ssh -vvv -i ~/.ssh/id_ec2 -o BatchMode=yes -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo Connected to $(hostname)" || (echo "SSH test failed" && exit 1)

      - name: Prepare remote directory
        run: |
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo mkdir -p /opt/wordpress && sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} /opt/wordpress"

      - name: Install Docker on EC2
        run: |
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          sudo dnf install -y docker
          sudo systemctl enable --now docker
          sudo mkdir -p /usr/local/lib/docker/cli-plugins
          sudo curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/lib/docker/cli-plugins/docker-compose
          sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
          sudo docker compose version
          EOF

      - name: Create dummy TLS cert if missing
        run: |
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          cd /opt/wordpress
          if [ ! -f certbot/conf/live/${BLOG_DOMAIN}/fullchain.pem ]; then
            echo "Creating dummy certificate for ${BLOG_DOMAIN}"
            sudo mkdir -p certbot/conf/live/${BLOG_DOMAIN}
            sudo openssl req -x509 -nodes -newkey rsa:2048 -days 1 \
              -keyout certbot/conf/live/${BLOG_DOMAIN}/privkey.pem \
              -out certbot/conf/live/${BLOG_DOMAIN}/fullchain.pem \
              -subj "/CN=${BLOG_DOMAIN}"
          fi
          EOF

      - name: Sync project to EC2
        run: rsync -az --delete --exclude='certbot/' --exclude='wp/wp-config.php' --exclude='wordpress-theme/' -e "ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes" ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/wordpress && rsync -az -e "ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes" wordpress-theme/ases-kahraba/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/wordpress/wp/wp-content/themes/aseskahraba/

      - name: Write .env on EC2
        env:
          RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
          RDS_DB: ${{ secrets.RDS_DB }}
          RDS_USER: ${{ secrets.RDS_USER }}
          RDS_PASS: ${{ secrets.RDS_PASS }}
          WP_HOME: ${{ secrets.WP_HOME }}
          WP_SITEURL: ${{ secrets.WP_SITEURL }}
        run: |
          # Validate secrets locally first
          if [ -z "$RDS_ENDPOINT" ] || [ -z "$RDS_DB" ] || [ -z "$RDS_USER" ] || [ -z "$RDS_PASS" ] || [ -z "$WP_HOME" ] || [ -z "$WP_SITEURL" ]; then
            echo "ERROR: Missing required secrets"
            echo "  RDS_ENDPOINT: ${RDS_ENDPOINT:-(empty)}"
            echo "  RDS_DB: ${RDS_DB:-(empty)}"
            echo "  RDS_USER: ${RDS_USER:-(empty)}"
            echo "  RDS_PASS: ${RDS_PASS:-(empty)}"
            echo "  WP_HOME: ${WP_HOME:-(empty)}"
            echo "  WP_SITEURL: ${WP_SITEURL:-(empty)}"
            exit 1
          fi
          
          # Create .env with explicit variable substitution (not inside heredoc to ensure expansion)
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} bash -c "
            set -e
            cd /opt/wordpress
            cat > .env << 'EOFENV'
          WORDPRESS_DB_HOST=$RDS_ENDPOINT
          WORDPRESS_DB_NAME=$RDS_DB
          WORDPRESS_DB_USER=$RDS_USER
          WORDPRESS_DB_PASSWORD=$RDS_PASS
          WORDPRESS_TABLE_PREFIX=wp_
          WORDPRESS_DEBUG=false
          WORDPRESS_CONFIG_EXTRA=define('WP_HOME','$WP_HOME'); define('WP_SITEURL','$WP_SITEURL');
          EOFENV
            
            echo '✓ .env file created'
            test -s .env || (echo 'ERROR: .env is empty' && exit 1)
            grep -q \"WORDPRESS_DB_HOST=$RDS_ENDPOINT\" .env || (echo 'ERROR: RDS endpoint not in .env' && exit 1)
            echo '✓ .env validation passed'
          "

      - name: Deploy stack
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          cd /opt/wordpress
          sudo docker compose pull
          sudo docker compose up -d --remove-orphans
          sudo docker system prune -f
          EOF

      - name: Fix WordPress permissions
        run: |
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          cd /opt/wordpress
          echo "Fixing WordPress file permissions..."
          sudo docker compose exec -T wordpress chown -R www-data:www-data /var/www/html/wp-content
          sudo docker compose exec -T wordpress chmod -R 775 /var/www/html/wp-content
          echo "✓ WordPress permissions fixed"
          EOF

      - name: Ensure WordPress core files exist
        run: |
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          cd /opt/wordpress
          if [ ! -f wp/index.php ] || [ ! -d wp/wp-admin ]; then
            echo "WordPress core files missing or incomplete. Downloading and extracting latest release..."
            cd /tmp && rm -rf wordpress latest.zip
            wget -q https://wordpress.org/latest.zip
            unzip -q latest.zip
            cd /opt/wordpress
            sudo rm -rf wp-admin wp-includes wp-*.php index.php license.txt readme.html xmlrpc.php 2>/dev/null || true
            sudo cp -r /tmp/wordpress/* /opt/wordpress/wp/
            sudo chown -R ec2-user:ec2-user /opt/wordpress/wp
            echo "WordPress core files restored"
          else
            echo "WordPress core files verified"
          fi
          EOF

      - name: Wait for database connectivity
        run: |
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          cd /opt/wordpress
          echo "Waiting for WordPress service to be ready..."
          sleep 5
          
          echo "Validating .env file..."
          RDS_ENDPOINT=$(grep WORDPRESS_DB_HOST .env | cut -d= -f2)
          RDS_USER=$(grep WORDPRESS_DB_USER .env | cut -d= -f2)
          RDS_PASS=$(grep WORDPRESS_DB_PASSWORD .env | cut -d= -f2)
          RDS_DB=$(grep WORDPRESS_DB_NAME .env | cut -d= -f2)
          
          if [ -z "$RDS_ENDPOINT" ] || [ -z "$RDS_USER" ] || [ -z "$RDS_PASS" ] || [ -z "$RDS_DB" ]; then
            echo "ERROR: Database credentials in .env are incomplete!"
            cat .env
            exit 1
          fi
          
          echo "Testing database connectivity to $RDS_ENDPOINT..."
          which mysql || (sudo dnf install -y mariadb-client)
          mysql -h $RDS_ENDPOINT -u $RDS_USER -p$RDS_PASS -e "SELECT 1" || (echo "Database connectivity failed. Verify RDS security groups and credentials." && exit 1)
          echo "Database connectivity verified"
          EOF

      - name: Issue/Renew Let's Encrypt
        run: |
          BLOG_DOMAIN="blog.aseskahraba.com"
          LETSENCRYPT_EMAIL="${{ secrets.LETSENCRYPT_EMAIL }}"
          ssh -i ~/.ssh/id_ec2 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            set -e
            cd /opt/wordpress
            mkdir -p certbot/conf certbot/www
            if [ -f certbot/conf/live/$BLOG_DOMAIN/fullchain.pem ]; then
              echo 'Renewing certificate for $BLOG_DOMAIN'
              # If renewal fails (e.g., broken config), fallback to issuing a fresh cert with the correct cert-name.
              sudo docker compose run --rm certbot renew --cert-name $BLOG_DOMAIN || sudo docker compose run --rm certbot certonly --cert-name $BLOG_DOMAIN --webroot -w /var/www/certbot -d $BLOG_DOMAIN --email $LETSENCRYPT_EMAIL --agree-tos --no-eff-email --non-interactive
            else
              echo 'Issuing certificate for $BLOG_DOMAIN'
              sudo docker compose run --rm certbot certonly --cert-name $BLOG_DOMAIN --webroot -w /var/www/certbot -d $BLOG_DOMAIN --email $LETSENCRYPT_EMAIL --agree-tos --no-eff-email --non-interactive
            fi
            # Ensure nginx sees the expected lineage path (avoid -0001 suffix issues)
            if [ -d certbot/conf/live/${BLOG_DOMAIN}-0001 ] && [ ! -d certbot/conf/live/${BLOG_DOMAIN} ]; then
              echo 'Linking ${BLOG_DOMAIN} to ${BLOG_DOMAIN}-0001 for nginx compatibility'
              (cd certbot/conf/live && sudo ln -sfn ${BLOG_DOMAIN}-0001 ${BLOG_DOMAIN})
            fi
            sudo docker compose restart nginx
          "

      # Health check step removed as requested
